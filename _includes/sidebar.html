{% assign posts = site.posts %}

{%- comment -%}
Pick a reference date:
- If we're on a post page (page.date exists), use that.
- Otherwise (welcome / non-post pages), use newest post.
{%- endcomment -%}
{% assign ref_date = page.date %}
{% if ref_date == nil %}
  {% assign ref_date = site.posts.first.date %}
{% endif %}

{% assign open_year_month = ref_date | date: "%Y-%m" %}

<div>
  <div style="font-weight:800; font-size: 1.1rem; margin-bottom: 8px;">
    {{ site.title }}
  </div>

  {%- assign years = posts | group_by_exp: "p", "p.date | date: '%Y'" -%}

  {%- for yg in years -%}
    <div style="font-weight:800; margin: 12px 0 6px;">
      {{ yg.name }}
    </div>

    {%- assign months = yg.items | group_by_exp: "p", "p.date | date: '%Y-%m'" -%}

    {%- for mg in months -%}
      {%- assign month_label = mg.name | date: "%B" -%}
      {%- assign should_open = false -%}
      {%- if mg.name == open_year_month -%}
        {%- assign should_open = true -%}
      {%- endif -%}

      <details class="month" style="margin: 6px 0;" {% if should_open %}open{% endif %}>
        <summary class="month-title" style="cursor: pointer;">
          {{ month_label }}
        </summary>

        <div style="padding-left: 14px; margin-top: 6px;">
          {%- assign day_groups = mg.items | group_by_exp: "p", "p.date | date: '%-d'" -%}
          {%- for dg in day_groups -%}
            {%- assign day = dg.name -%}
            {%- assign newest_post_that_day = dg.items[0] -%}

            {%- assign is_active = false -%}
            {%- if page.url == newest_post_that_day.url -%}
              {%- assign is_active = true -%}
            {%- endif -%}

            <a class="day {% if is_active %}active{% endif %}"
               href="{{ newest_post_that_day.url | relative_url }}">
              {{ day }}{% if newest_post_that_day.title %} - {{ newest_post_that_day.title }}{% endif %}
            </a>
          {%- endfor -%}
        </div>
      </details>
    {%- endfor -%}
  {%- endfor -%}
</div>
