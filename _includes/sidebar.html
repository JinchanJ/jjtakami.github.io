{% assign posts = site.posts %}

<div>
  <a href="{{ '/' | relative_url }}"
    style="display:block; font-weight:800; font-size: 1.1rem; margin-bottom: 8px; text-decoration:none; color:inherit;">
    {{ site.title }}
  </a>

  {%- assign years = posts | group_by_exp: "p", "p.date | date: '%Y'" -%}

  {%- for yg in years -%}
    <div style="font-weight:800; margin: 12px 0 6px;">
      {{ yg.name }}
    </div>

    {%- assign months = yg.items | group_by_exp: "p", "p.date | date: '%Y-%m'" -%}

    {%- for mg in months -%}
      {%- assign month_label = mg.name | date: "%B" -%}

      {%- comment -%}
      Determine whether this month should be open:
      - open if it contains the current page (active post), else
      - open the newest month (first month of the first year group)
      {%- endcomment -%}

      {%- assign has_active = false -%}
      {%- for p in mg.items -%}
        {%- if page.url == p.url -%}
          {%- assign has_active = true -%}
        {%- endif -%}
      {%- endfor -%}

      {%- assign is_newest_month = false -%}
      {%- if forloop.first and forloop.parentloop.first -%}
        {%- assign is_newest_month = true -%}
      {%- endif -%}

      <details class="month" style="margin: 6px 0;"
        {% if has_active or is_newest_month %}open{% endif %}>
        <summary class="month-title" style="cursor: pointer;">
          {{ month_label }}
        </summary>

        <div style="padding-left: 14px; margin-top: 6px;">
          {%- assign day_groups = mg.items | group_by_exp: "p", "p.date | date: '%-d'" -%}
          {%- for dg in day_groups -%}
            {%- assign day = dg.name -%}
            {%- assign newest_post_that_day = dg.items[0] -%}

            {%- assign is_active = false -%}
            {%- if page.url == newest_post_that_day.url -%}
              {%- assign is_active = true -%}
            {%- endif -%}

            <a class="day {% if is_active %}active{% endif %}"
               href="{{ newest_post_that_day.url | relative_url }}">
              {{ day }}{% if newest_post_that_day.title %} | {{ newest_post_that_day.title }}{% endif %}
            </a>
          {%- endfor -%}
        </div>
      </details>
    {%- endfor -%}
  {%- endfor -%}
</div>
