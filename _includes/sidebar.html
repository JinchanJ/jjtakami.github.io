{% assign posts = site.posts %}

{%- comment -%}
Pick a "reference" post:
- If we're viewing a post page, use that post's date
- Otherwise (welcome page), use the most recent post
{%- endcomment -%}
{% assign ref_post = page %}
{% if ref_post.date == nil %}
  {% assign ref_post = site.posts.first %}
{% endif %}

{% assign sel_year  = ref_post.date | date: "%Y" %}
{% assign sel_month = ref_post.date | date: "%Y-%m" %}

<div class="sidebar">

  <a class="site-title" href="{{ '/' | relative_url }}">
    {{ site.title }}
  </a>

  {%- assign years = posts | group_by_exp: "p", "p.date | date: '%Y'" -%}

  {%- for yg in years -%}
    {%- assign year_id = "year-" | append: yg.name -%}
    <div class="year">

      <input
        class="toggle year-toggle"
        type="radio"
        name="year-accordion"
        id="{{ year_id }}"
        {% if yg.name == sel_year %}checked{% endif %}
      />
      <label class="year-label" for="{{ year_id }}">
        {{ yg.name }}
        <span class="caret">▾</span>
      </label>

      <div class="months">
        {%- assign months = yg.items | group_by_exp: "p", "p.date | date: '%Y-%m'" -%}

        {%- for mg in months -%}
          {%- assign month_id = "month-" | append: mg.name -%}
          {%- assign month_label = mg.name | date: "%B" -%}

          <div class="month">

            <input
              class="toggle month-toggle"
              type="radio"
              name="month-accordion"
              id="{{ month_id }}"
              {% if mg.name == sel_month %}checked{% endif %}
            />
            <label class="month-label" for="{{ month_id }}">
              {{ month_label }}
              <span class="caret">▾</span>
            </label>

            <div class="days">
              {%- assign day_groups = mg.items | group_by_exp: "p", "p.date | date: '%-d'" -%}
              {%- for dg in day_groups -%}
                {%- assign day = dg.name -%}
                {%- assign newest_post_that_day = dg.items[0] -%}

                {%- assign is_active = false -%}
                {%- if page.url == newest_post_that_day.url -%}
                  {%- assign is_active = true -%}
                {%- endif -%}

                <a class="day {% if is_active %}active{% endif %}"
                   href="{{ newest_post_that_day.url | relative_url }}">
                  {{ day }}{% if newest_post_that_day.title %} | {{ newest_post_that_day.title }}{% endif %}
                </a>
              {%- endfor -%}
            </div>

          </div>
        {%- endfor -%}
      </div>

    </div>
  {%- endfor -%}

</div>
